generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

enum PlatformRole {
  SUPER_ADMIN
  ADMIN
  SUPPORT
}

enum RestaurantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  CANCELLED
}

enum RestaurantPlan {
  CORE
  SERVICE_PRO
  FULL_SUITE
}

enum HostingStatus {
  ACTIVE
  SUSPENDED
  SELF_HOSTED
}

enum LicenseEventType {
  CREATED
  ACTIVATED
  SUSPENDED
  REACTIVATED
  CANCELLED
  KEY_ROTATED
  LICENSE_CREATED
  LICENSE_KEY_ROTATED
  LICENSE_VALIDATED
  ADMIN_LOGIN
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  SETTINGS_UPDATED
  ADDON_ENABLED
  ADDON_DISABLED
  PLAN_CHANGED
  STATUS_CHANGED
  ADDON_SYNCED
  ADDON_SYNC_FAILED
}

enum HealthStatus {
  HEALTHY
  UNHEALTHY
  UNREACHABLE
}

model PlatformUser {
  id        String       @id @default(cuid())
  email     String       @unique
  password  String
  name      String
  role      PlatformRole
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model Restaurant {
  id                   String           @id @default(cuid())
  slug                 String           @unique
  name                 String
  domain               String?
  adminEmail           String
  status               RestaurantStatus @default(ACTIVE)
  provisionStatus      String           @default("active")
  provisionLog         String?
  generatedPassword    String?
  plan                 RestaurantPlan   @default(CORE)
  port                 Int              @unique
  dbPath               String
  licenseKey           String           @unique @default(uuid())
  licenseExpiry        DateTime?
  licenseActivatedAt   DateTime?
  addonSms             Boolean          @default(false)
  addonFloorPlan       Boolean          @default(false)
  addonReporting       Boolean          @default(false)
  addonGuestHistory    Boolean          @default(false)
  addonEventTicketing  Boolean          @default(false)
  hosted               Boolean          @default(true)
  hostingStatus        HostingStatus    @default(ACTIVE)
  ownerName            String?
  ownerEmail           String?
  ownerPhone           String?
  trialEndsAt          DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  monthlyHostingActive Boolean          @default(false)
  oneTimeRevenue       Int?
  notes                String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  licenseEvents   LicenseEvent[]
  healthChecks    HealthCheck[]
  emailSequences  EmailSequenceEvent[]
}

model LicenseEvent {
  id           String           @id @default(cuid())
  restaurantId String
  restaurant   Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  event        LicenseEventType
  details      String?
  performedBy  String?
  createdAt    DateTime         @default(now())

  @@index([restaurantId, createdAt])
}

model HealthCheck {
  id             String       @id @default(cuid())
  restaurantId   String
  restaurant     Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  status         HealthStatus
  responseTimeMs Int?
  checkedAt      DateTime     @default(now())

  @@index([restaurantId, checkedAt])
}

model EmailSequenceEvent {
  id           String     @id @default(uuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  trigger      String
  sequenceStep Int
  scheduledAt  DateTime
  sentAt       DateTime?
  emailTo      String
  emailSubject String
  emailBody    String     @default("")
  status       String     @default("pending")
  createdAt    DateTime   @default(now())

  @@index([restaurantId, scheduledAt])
  @@index([status, scheduledAt])
}

model MarketingSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}
